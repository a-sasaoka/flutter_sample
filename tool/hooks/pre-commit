#!/bin/bash
# ===============================================
# Git pre-commit hook
# - Flutter analyzeï¼ˆé™çš„è§£æï¼‰
# - Dart formatï¼ˆæ•´å½¢æ¼ã‚Œãƒã‚§ãƒƒã‚¯ï¼‰
# ===============================================

set -euo pipefail

# --- ã‚³ãƒãƒ³ãƒ‰è§£æ±ºï¼ˆFVMå„ªå…ˆï¼‰ ---
flutter_cmd="flutter"
dart_cmd="dart"
if command -v fvm >/dev/null 2>&1; then
  flutter_cmd="fvm flutter"
  dart_cmd="fvm dart"
fi

echo "ğŸ” Running analyze..."
# è§£æã«å¤±æ•—ã—ãŸã‚‰ã‚³ãƒŸãƒƒãƒˆä¸­æ–­
$flutter_cmd analyze

# å¤‰æ›´ã‚¹ãƒ†ãƒ¼ã‚¸æ¸ˆã¿ã® Dart ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’æ•´å½¢ãƒã‚§ãƒƒã‚¯
staged_dart_files=$(git diff --cached --name-only -- '*.dart' || true)

if [ -n "$staged_dart_files" ]; then
  echo "ğŸ§¹ Checking format (staged .dart only)..."
  # æ•´å½¢ãŒå¿…è¦ãªã‚‰éã‚¼ãƒ­çµ‚äº†ã§ã‚³ãƒŸãƒƒãƒˆä¸­æ–­
  # ï¼ˆè‡ªå‹•æ•´å½¢ã¯è¡Œã‚ãšã€ç›´ã—ã¦ã‹ã‚‰å†ã‚³ãƒŸãƒƒãƒˆã—ã¦ã‚‚ã‚‰ã†é‹ç”¨ï¼‰
  $dart_cmd format --set-exit-if-changed $staged_dart_files
else
  echo "â„¹ï¸  Staged .dart files not found. Skipping format check."
fi

echo "âœ… All checks passed. Proceeding with commit..."